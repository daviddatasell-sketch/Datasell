# Google Sign-In Database Integration & User Management

## Overview
Google Sign-In users are now fully integrated into the DataSell database alongside regular email/password users. All user data is stored in the same Firebase Realtime Database location, ensuring seamless admin portal visibility and user management.

## User Storage Location
All users (Google Sign-In + Email/Password) are stored in:
```
Firebase Realtime Database → users/{userId}
```

## User Data Structure

### Google Sign-In Users
When a user signs in with Google, the following data is stored:
```javascript
{
  uid: "Google Firebase UID",
  email: "user@gmail.com",
  firstName: "Emmanuel",           // Extracted from Google displayName
  lastName: "Fotsi",               // Extracted from Google displayName
  displayName: "Emmanuel Fotsi",   // Full name from Google account
  photoURL: "https://...",         // Google profile picture
  walletBalance: 0,
  createdAt: "2026-01-31T10:20:00Z",
  lastLogin: "2026-01-31T10:25:00Z",
  isAdmin: false,
  pricingGroup: "regular",
  suspended: false,
  signInMethod: "google"           // Sign-in method identifier
}
```

### Email/Password Users
When a user signs up with email/password, the following data is stored:
```javascript
{
  uid: "Firebase UID or user_xxxxx",
  firstName: "John",
  lastName: "Doe",
  email: "john@example.com",
  phone: "+233xxxxxxxxx",          // Normalized Ghanaian phone number
  passwordHash: "hashed_password",  // For database auth fallback
  walletBalance: 0,
  createdAt: "2026-01-31T10:20:00Z",
  lastLogin: "2026-01-31T10:25:00Z",
  isAdmin: false,
  pricingGroup: "regular",
  suspended: false,
  authMethod: "firebase|database",  // Authentication system used
  signInMethod: "email"             // Sign-in method identifier
}
```

## Key Implementation Details

### 1. Display Name Handling
- **Google Users**: The actual name the user registered their Google account with (e.g., "Emmanuel Fotsi")
- **No fallback to email prefix**: If Google provides a display name, that's what's used
- **Proper parsing**: "Emmanuel Fotsi" is parsed into:
  - `firstName: "Emmanuel"`
  - `lastName: "Fotsi"`
  - `displayName: "Emmanuel Fotsi"`

### 2. User ID Assignment
- **Google Users**: Firebase UID from Google OAuth (automatically generated by Google/Firebase)
- **Email Users**: Firebase UID (when Firebase Auth is available) or custom `user_xxxxx` format

### 3. Sign-In Method Tracking
The `signInMethod` field allows admins to identify how each user registered:
- `"google"` - Google Sign-In
- `"email"` - Email/Password signup

## Admin Portal Integration

### User Management View
The admin portal (`/admin`) displays all users in the **User Management** tab with:
- **User ID**: First 8 characters of the UID (e.g., "abc12345...")
- **Name**: Concatenation of firstName + lastName
- **Email**: User's email address
- **Phone**: Phone number (N/A for Google-only users without phone)
- **Balance**: Current wallet balance in GHS
- **Date Joined**: createdAt timestamp
- **Pricing Tier**: regular/vip/premium with commission rates
- **Actions**: Fund management buttons

### User Activities & Tracking
All user activities are tracked in the `transactions` and `userLogs` collections:
- Transaction history (purchases, refunds, transfers)
- Login history via `lastLogin` timestamp
- Account creation tracking via `createdAt` timestamp
- Admin actions logged with timestamps and user IDs

### Data Queries
The `/api/admin/users` endpoint retrieves all users with computed fields:
```javascript
{
  uid,
  ...userData,
  totalSpent: sum of all user transactions,
  transactionCount: number of transactions,
  lastActivity: last login or creation date,
  status: "active" or "suspended",
  pricingGroup: user's current tier
}
```

## Backend Endpoints

### Google Sign-In Endpoint
**POST** `/api/google-login`
- Accepts: `{ idToken, email, uid, displayName, photoURL }`
- Creates/updates user in database
- Establishes server session
- Returns: `{ success: true, user, sessionID }`

### Admin Users List
**GET** `/api/admin/users`
- Requires: Admin authentication
- Returns: Array of all users with computed metrics
- No filtering by sign-in method (shows all users)

## Database Structure

```
firebase-realtime-database/
├── users/
│   ├── {uid1}/
│   │   ├── uid
│   │   ├── email
│   │   ├── firstName
│   │   ├── lastName
│   │   ├── displayName
│   │   ├── walletBalance
│   │   ├── createdAt
│   │   ├── lastLogin
│   │   ├── signInMethod (google|email)
│   │   ├── photoURL
│   │   └── ... other fields
│   └── {uid2}/
│       └── ... similar structure
├── transactions/
│   ├── {transId}/
│   │   ├── userId
│   │   ├── amount
│   │   ├── timestamp
│   │   └── ...
└── userLogs/
    ├── {logId}/
    │   ├── userId
    │   ├── action
    │   ├── timestamp
    │   └── ...
```

## User Activity Tracking

Google Sign-In users' activities are tracked through:

1. **Transaction Records**: All purchases/refunds recorded with userId
2. **User Logs**: Registration, login attempts, admin actions
3. **Last Login**: Updated on each sign-in
4. **Wallet Balance**: Updated with transaction history
5. **Pricing Group**: Admin can change tier anytime

## Admin Rectification & Management

Admins can easily manage Google Sign-In users because:

✅ **Unique User ID**: Each user has a unique Firebase UID for easy lookup
✅ **Full Name**: Real name from Google account displayed (not email prefix)
✅ **Email Verified**: Google accounts are pre-verified by Google
✅ **Activity History**: All transactions and logins tracked
✅ **Fund Management**: Can add/deduct funds for any user
✅ **Tier Management**: Can upgrade/downgrade pricing tier
✅ **Suspension**: Can suspend accounts if needed
✅ **Sign-In Method**: Can see how each user registered (google vs email)

## Testing the Integration

1. **Sign in with Google**: Click "Sign in with Google" button on login page
2. **Verify user creation**: Check Firebase Realtime Database → users/
3. **Check admin portal**: Visit `/admin` → Users tab
4. **Verify displayed name**: Should show your actual Google account name (e.g., "Emmanuel Fotsi")
5. **Check activities**: Transaction history and login timestamps visible
6. **Test admin actions**: Try adding funds, changing tier, or suspending account

## Important Notes

- ✅ No phone number required for Google Sign-In users
- ✅ Google profile picture stored in `photoURL` for future use
- ✅ All users tracked together in single database collection
- ✅ Admin portal works seamlessly with both sign-in methods
- ✅ Easy user identification via `signInMethod` field
- ✅ All rectifications possible through standard admin endpoints
